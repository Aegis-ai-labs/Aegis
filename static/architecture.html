<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEGIS1 Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --secondary: #0088ff;
            --background: #0a0a0a;
            --surface: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-muted: #888;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        /* Navigation */
        nav {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: 2px;
        }
        
        nav ul {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav a:hover, nav a.active {
            color: var(--primary);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .subtitle {
            color: var(--text-muted);
            margin-bottom: 40px;
        }
        
        /* Sections */
        .section {
            margin-bottom: 60px;
        }
        
        h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        /* Diagram */
        .diagram {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
        
        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        .card h3 {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .card p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: rgba(0, 255, 136, 0.1);
            color: var(--primary);
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        td {
            font-size: 14px;
            color: var(--text);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--primary);
            border-radius: 20px;
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .code-block {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 15px;
        }
        
        .highlight {
            background: rgba(0, 255, 136, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
            .grid { grid-template-columns: 1fr; }
            table { font-size: 12px; }
            th, td { padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="logo">â¬¢ AEGIS1</div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="modern-dashboard.html">Dashboard</a></li>
            <li><a href="chat.html">Chat</a></li>
            <li><a href="architecture.html" class="active">Architecture</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <h1>System Architecture</h1>
        <p class="subtitle">AEGIS1 â€” Complete Overview of Components and Data Flow</p>
        
        <!-- System Overview -->
        <section class="section">
            <h2>System Overview</h2>
            <div class="diagram">
                <div class="mermaid">
graph TB
    ESP["ESP32 Pendant<br/>Mic + Speaker + WiFi"]
    WS["WebSocket<br/>Binary PCM Stream"]
    FastAPI["FastAPI Server<br/>main.py"]
    STT["STT Pipeline<br/>Moonshine/Whisper"]
    Claude["Claude API<br/>Opus 4.6 + Haiku 4.5"]
    TTS["TTS Pipeline<br/>Kokoro/Piper"]
    DB["SQLite Database<br/>Health + Expenses + Tasks"]
    Tools["10 Claude Tools<br/>Health â€¢ Wealth â€¢ Tasks"]
    
    ESP -->|PCM Audio| WS
    WS -->|WebSocket| FastAPI
    FastAPI -->|Stream| STT
    STT -->|Text| Claude
    Claude -->|Tool Calls| Tools
    Tools -->|Results| Claude
    Claude -->|Text Chunks| TTS
    TTS -->|Audio| FastAPI
    FastAPI -->|Binary| WS
    WS -->|Audio| ESP
    FastAPI -->|Read/Write| DB
    FastAPI -->|Real-time| Dashboard["Dashboard<br/>WebSocket"]
                </div>
            </div>
        </section>
        
        <!-- Model Routing -->
        <section class="section">
            <h2>Intelligent Model Routing</h2>
            <div class="grid">
                <div class="card">
                    <h3>âš¡ Haiku 4.5 (Fast)</h3>
                    <p>Used for quick queries, status checks, and simple tool dispatch.</p>
                    <p style="margin-top: 12px; font-size: 12px; font-weight: 600;">
                        <span class="highlight">TTFT: &lt;200ms</span> â€¢ 80% of queries
                    </p>
                </div>
                <div class="card">
                    <h3>ðŸ§  Opus 4.6 (Smart)</h3>
                    <p>Used for complex reasoning, pattern analysis, and extended thinking.</p>
                    <p style="margin-top: 12px; font-size: 12px; font-weight: 600;">
                        <span class="highlight">TTFT: ~2s</span> â€¢ 20% of queries
                    </p>
                </div>
                <div class="card">
                    <h3>ðŸŽ¯ Trigger Keywords</h3>
                    <p>Router detects: "why", "analyze", "correlate", "trend", "explain", "plan", "complex"</p>
                    <p style="margin-top: 12px; font-size: 12px; font-weight: 600;">
                        <span class="highlight">Auto-routes to Opus</span>
                    </p>
                </div>
            </div>
        </section>
        
        <!-- Core Tools -->
        <section class="section">
            <h2>10 Claude Tools</h2>
            <table>
                <tr>
                    <th>Category</th>
                    <th>Tool Name</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><span class="badge">Health</span></td>
                    <td><code>log_health</code></td>
                    <td>Record sleep, mood, heart rate, exercise</td>
                </tr>
                <tr>
                    <td><span class="badge">Health</span></td>
                    <td><code>get_health_today</code></td>
                    <td>Retrieve today's metrics</td>
                </tr>
                <tr>
                    <td><span class="badge">Health</span></td>
                    <td><code>get_health_summary</code></td>
                    <td>7-day trends and patterns</td>
                </tr>
                <tr>
                    <td><span class="badge">Wealth</span></td>
                    <td><code>track_expense</code></td>
                    <td>Log spending by category</td>
                </tr>
                <tr>
                    <td><span class="badge">Wealth</span></td>
                    <td><code>get_spending_today</code></td>
                    <td>Daily expenses</td>
                </tr>
                <tr>
                    <td><span class="badge">Wealth</span></td>
                    <td><code>get_spending_summary</code></td>
                    <td>30-day breakdown</td>
                </tr>
                <tr>
                    <td><span class="badge">Wealth</span></td>
                    <td><code>get_budget_status</code></td>
                    <td>Budget remaining</td>
                </tr>
                <tr>
                    <td><span class="badge">Tasks</span></td>
                    <td><code>create_background_task</code></td>
                    <td>Create autonomous task</td>
                </tr>
                <tr>
                    <td><span class="badge">Tasks</span></td>
                    <td><code>get_task_status</code></td>
                    <td>Check task progress</td>
                </tr>
                <tr>
                    <td><span class="badge">Tasks</span></td>
                    <td><code>list_all_tasks</code></td>
                    <td>List pending/active/completed</td>
                </tr>
            </table>
        </section>
        
        <!-- Tech Stack -->
        <section class="section">
            <h2>Technology Stack</h2>
            <div class="grid">
                <div class="card">
                    <h3>Backend</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted); line-height: 1.8;">
                        <li>âœ“ FastAPI 0.115</li>
                        <li>âœ“ Python 3.10+</li>
                        <li>âœ“ Uvicorn WebSocket</li>
                        <li>âœ“ SQLite with WAL</li>
                        <li>âœ“ Asyncio concurrency</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>AI/ML</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted); line-height: 1.8;">
                        <li>âœ“ Claude Opus 4.6</li>
                        <li>âœ“ Claude Haiku 4.5</li>
                        <li>âœ“ Extended Thinking</li>
                        <li>âœ“ Tool Use Loop</li>
                        <li>âœ“ Streaming Response</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Audio</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted); line-height: 1.8;">
                        <li>âœ“ Moonshine STT (27M)</li>
                        <li>âœ“ Kokoro TTS (82M)</li>
                        <li>âœ“ Silero VAD</li>
                        <li>âœ“ ADPCM Codec</li>
                        <li>âœ“ 16kHz PCM Stream</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Infrastructure</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted); line-height: 1.8;">
                        <li>âœ“ ESP32 DevKit V1</li>
                        <li>âœ“ INMP441 Mic</li>
                        <li>âœ“ PAM8403 Speaker</li>
                        <li>âœ“ WiFi 802.11n</li>
                        <li>âœ“ 4+ hour battery</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- Performance -->
        <section class="section">
            <h2>Performance Metrics</h2>
            <table>
                <tr>
                    <th>Operation</th>
                    <th>Latency</th>
                    <th>Target</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>Haiku Response (TTFT)</td>
                    <td>&lt;200ms</td>
                    <td>&lt;200ms</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
                <tr>
                    <td>Opus Response (TTFT)</td>
                    <td>~2s</td>
                    <td>&lt;5s</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
                <tr>
                    <td>TTS Latency</td>
                    <td>&lt;100ms</td>
                    <td>&lt;200ms</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
                <tr>
                    <td>STT Latency</td>
                    <td>&lt;150ms</td>
                    <td>&lt;300ms</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
                <tr>
                    <td>Database Query (100 items)</td>
                    <td>&lt;10ms</td>
                    <td>&lt;50ms</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
                <tr>
                    <td>Parallel Task Execution (15 tasks)</td>
                    <td>~0.8s</td>
                    <td>&lt;2s</td>
                    <td style="color: var(--primary);">âœ“ OK</td>
                </tr>
            </table>
        </section>
        
        <!-- Data Flow -->
        <section class="section">
            <h2>Request/Response Cycle</h2>
            <div class="code-block">
1. User speaks into ESP32
2. Mic captures 16kHz PCM audio (200ms chunks)
3. ESP32 sends binary PCM via WebSocket
4. FastAPI receives stream â†’ VAD detects voice
5. STT converts audio â†’ text
6. Claude receives text + context (health + spending data)
7. Claude routing: token count â†’ Haiku (fast) or Opus (smart)
8. Claude calls tools if needed (health summary, expense tracking, etc)
9. Claude generates response
10. TTS converts response â†’ audio (sentence-level streaming)
11. FastAPI sends binary audio back via WebSocket
12. ESP32 plays audio through PAM8403 speaker
13. User hears response (~2-3s end-to-end)
            </div>
        </section>
        
        <!-- Database Schema -->
        <section class="section">
            <h2>Database Schema</h2>
            <div class="grid">
                <div class="card">
                    <h3>health_logs</h3>
                    <p>Tracks sleep, steps, heart rate, mood, weight, water, exercise</p>
                    <div class="code-block" style="margin-top: 10px;">
metric, value, notes, timestamp
                    </div>
                </div>
                <div class="card">
                    <h3>expenses</h3>
                    <p>Spending by category with descriptions</p>
                    <div class="code-block" style="margin-top: 10px;">
amount, category, description, timestamp
                    </div>
                </div>
                <div class="card">
                    <h3>tasks</h3>
                    <p>Background autonomous task execution</p>
                    <div class="code-block" style="margin-top: 10px;">
title, status, priority, result, error, schedule
                    </div>
                </div>
                <div class="card">
                    <h3>conversations</h3>
                    <p>Chat history with model and latency tracking</p>
                    <div class="code-block" style="margin-top: 10px;">
role, content, model_used, latency_ms, timestamp
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</body>
</html>
